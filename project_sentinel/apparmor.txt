# Project Sentinel AppArmor Profile
# Updated for s6-overlay v3 compatibility in Home Assistant.

#include <tunables/global>

profile ###SLUG### flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/nameservice>

  # Core s6-overlay v3 execution permissions
  /init rmix,
  /bin/** rmix,
  /sbin/** rmix,
  /usr/bin/** rmix,
  /usr/sbin/** rmix,
  /lib/** rmix,
  /usr/lib/** rmix,
  /usr/libexec/** rmix,
  
  # s6-overlay specific runtime paths
  /run/s6/** rmix,
  /run/s6-rc*/** rmix,
  /run/service/** rmix,
  
  # Capabilities required for init and network scanning
  capability net_admin,
  capability net_raw,
  capability setuid,
  capability setgid,
  capability sys_chroot,

  # Network access
  network,

  # Filesystem access
  /share/sentinel.db* rw,
  /data/** rw,
  /tmp/** rw,
  /run/** rw,
  /proc/** r,
  /sys/** r,
  
  # Python specifics
  /usr/local/lib/python*/** r,
  /usr/local/bin/python* rmix,

  # Deny critical host files
  deny /etc/passwd r,
  deny /etc/shadow r,
}
